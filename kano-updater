#!/bin/bash

# kano-updater
#
# Copyright (C) 2013 Kano Computing Ltd.
# License:   http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# Updates system packages and firmware, expands root partition if needed
#

source /usr/share/kano-toolset/make-common

APT_LOG=/var/log/apt/history.log
APT_AUX=/tmp/history_aux.log

# Wait on infinite loop until PS has died
function waitTillPSEnds()
{
  while true; do
    if ! ps -p $1 > /dev/null 2>&1; then
      break
    else
      sleep 1
    fi
  done
}

function update()
{
   sudo apt-get -y update
   sudo apt-get -y dist-upgrade
   sudo apt-get -y autoremove
   sudo apt-get -y autoclean
}

function expand()
{
   sudo /usr/bin/expand-rootfs
}

function updateFirmware()
{
  sudo rpi-update
}

# Check for root priviledges
if [ `id -u` -ne 0 ]; then
  echo "Error: kano-updater must be executed with root privileges" 1>&2
  exit 1
fi

# Close open projects
kill_apps

# Check for internet connection
ping -q www.google.com -c 1 &> /dev/null
INTERNET_ON=$?
UPDATED=2

if [ $INTERNET_ON -eq 0 ]; then

  # Create a copy of the current history log
  if [ -e $APT_LOG ]; then
    cp $APT_LOG $APT_AUX
  else
    touch $APT_AUX
  fi

  # Ask for system package upgrades
  # then follow progress with Zenity dialog
  update &
  PID=$!
  UPDATED=0
  # progress dialog
  (
  for I in {0..99..1}; do
    sleep 2
    # Check if the Update process is still alive
    if ! ps -p $PID > /dev/null 2>&1; then
        # the update is ready
        echo "99"
        break
    fi
    echo "$I"
  done

  waitTillPSEnds $PID
  echo "#Ready"
  sleep 1
  echo "100"
  ) |
  zenity --progress --no-cancel --text="Updating Kanux..." --width=300 --height=90 --auto-close --auto-kill
fi

# Resize the root partition if needed
expand
RESIZED=$?

# Check for a firmware update
# if disk partition has already been resized and there is internet
if [ $RESIZED -eq 1 ] && [ $INTERNET_ON -eq 0 ]; then

  # Ask for firmware update
  # then follow progress with Zenity dialog
  updateFirmware &
  PID=$!
  UPDATED=0
  # progress dialog
  (
  for I in {0..99..1}; do
    sleep 3
    # Check if the Firmware Update process is still alive
    if ! ps -p $PID > /dev/null 2>&1; then
        # the update is ready
        echo "99"
        break
    fi
    echo "$I"
  done

  waitTillPSEnds $PID
  echo "#Ready"
  sleep 1
  echo "100"
  ) |
  zenity --progress --no-cancel --text="Updating firmware..." --width=300 --height=90 --auto-close --auto-kill
# If no internet needs to be checked here because SD card can be resized without it
elif [ $INTERNET_ON -eq 2 ]; then
  zenity --text="Please connect to the Internet first" --info
  exit 0
fi

# Update has finished
if [ $UPDATED -eq 0 ]; then
  line=$(tail -1 /etc/kanux_version)
  zenity --text="Kanux successfully updated.\nVersion: $line \n\nThank you!" --info

  # Display log file
  FILE=/tmp/update.log
  # Create diff file
  grep -Fxvf $APT_AUX $APT_LOG > $FILE
  if [ -s $FILE ]; then
    zenity --text-info --title="Changelog" --filename=$FILE
  fi
  # Clean-up
  rm -f $FILE
  rm -f $APT_AUX
fi

# Resizing took place > reboot
if [ $RESIZED -eq 0 ]; then
  zenity --info --text="Disk partition scheduled for resize.\nRebooting the system, see you in 2 mins!"
  sudo /sbin/reboot
fi

exit 0
